# 🚀 '기내뭐돼' 최종 RAG 파이프라인 계획안 (UX 및 계층 구조 통합판)

## 🌟 서비스 핵심 철학 및 차별화 전략 (Core Value)
1. **정확성 (Law-based):** RAG 기술을 활용해 공식 법령 및 보안 규정 원문 데이터만 참조하여 답변의 정확도 극대화.
2. **중립성 (Independent):** 특정 항공사에 속하지 않은 독립 플랫폼으로서, 메타데이터 교차 검색을 통해 통합/객관적 규정 제공.
3. **편의성 (Conversational):** 사용자 환경에 최적화된 대화형 챗봇을 통해 복잡한 규정을 누구나 이해하기 쉬운 언어로 전달.

---

## 1단계: 오프라인 데이터 적재 (Data Ingestion & Indexing)

- **데이터 소스:** 제공받은 index_docstore_export.jsonl 파일을 활용.
- **데이터 증강(Augmentation):** 벡터화 전, 각 규정의 `page_content`에 사용자가 자주 묻는 구체적인 하위 품목 예시(동의어/브랜드명) 추가.
- **임베딩:** OpenAI의 text-embedding-3-small 등을 사용하여 증강된 page_content 텍스트를 벡터로 변환.
- **메타데이터 분리 저장:** recommended_metadata 안의 값들을 추출하여 벡터 DB의 메타데이터 필드에 매핑.

## 2단계: 대화 상태 관리 및 의도 파악 (Router & Slot Filling) ⭐️

AI는 대화 시작 시점부터 아래 **'데이터 계층 구조'**의 우선순위에 따라 필수 인풋값을 확보합니다.

- **[우선순위 1] 노선 정보 (출발지, 도착지)**
  - 정보 부재 시: "어디에서 출발하여 어디로 가시나요?" 질문 (즉시 개입).
  - 정보 중복 시: 출발지와 도착지가 같은 경우 에러 메시지 출력 후 대기.
- **[우선순위 2] 대상 물품 (물품명/Item)**
  - 정보 부재 시: "어떤 물건의 반입 규정이 궁금하신가요?" 질문.
  - 정보 확인 시: 공식 규정 데이터인 `item_original`과 매핑 시도.
- **[우선순위 3] 상세 속성 (Wh, ml, 수량 등)**
  - 노선과 물품이 확정된 후, 해당 규정(`page_content`)에서 요구하는 세부 수치를 기반으로 확인.
  - *(UX 개선 적용)*: 사용자 피로도를 줄이기 위해 직접 수치를 되묻기보다는, 4단계 생성기에서 "100ml 이하일 경우 가능합니다"와 같이 허용 범위를 먼저 안내하는 방식으로 동적 처리.

- **다중 물품 분리 (Multi-Intent Parsing):** 사용자가 여러 물품을 한 번에 물어볼 경우, 각각 독립적인 검색 파이프라인을 태울 수 있도록 분리.
- **포괄적 질문 제어 (Broad Query Handling):** "반입 금지 물품 다 알려줘" 등 광범위한 질문 시, 카테고리 버튼을 제시하여 범위 축소 유도.

## 3단계: 쿼리 재작성 및 하이브리드 검색 (Rewriter & Retriever)

- **카테고리 매핑(용어 정규화):** 사용자의 구체적인 물품명(예: 고추장)을 LLM을 거쳐 공식 전문 용어(예: 액체·분무·겔류)로 1차 매핑.
- **교차 메타데이터 검색 (Self-Querying):** 확정된 '노선 정보'를 바탕으로 필터 조건을 자동 생성하여 한국/미국 등 관련 국가 규정을 동시에 교차 검색.
- **병렬 검색 (Parallel Retrieval):** 분리된 다중 물품에 대해 각각 동시에 벡터 DB를 검색하여 속도 지연 방지.

## 4단계: 최종 판정 및 답변 생성 (Judge & Generator)

- **결론 선행 출력 (Bottom-Line First):** 직관적인 이모지(🟢/🟡/🔴)와 함께 결론(기내/위탁 가능 여부)을 최상단에 먼저 출력.
- **Bullet Point 요약:** 긴 줄글을 피하고, 허용 조건(reason_and_condition)을 2~3줄의 간결한 글머리 기호(-)로 요약하여 안내.
- **엄격한 판정 룰:** 검색된 출/도착국 규정 중 단 하나라도 prohibited면 최종 [반입 절대 불가] 처리.
- **환각 방지 (Fallback):** 검색 결과가 임계값 이하이거나 데이터에 없는 물품인 경우, 억측하지 않고 정중하게 모른다고 답변 후 항공사 고객센터 안내.